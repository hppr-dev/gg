# Gin Gorm Middleware

Gin middleware to create api endpoints for gorm models.

# Using The middleware

Activate the middleware by calling Use on your instance of gin.Engine (from gin.Default(), gin.New(), etc).
Then you may call the provided handler functions to set up basic endpoints.

Note: migration is outside of the scope of this project. Make sure to apply migrations before running the server.

Simple example server:

```

  import (
    "gorm.io/gorm"
    "github.com/gin-gonic/gin"
    "hppr.dev/gg"
  )

  type User struct {
    gorm.Model
    Name string
    Password string
  }
  type Post struct {
    gorm.Model
    Text string
    UserID uint64
    User User
  }


  func main() {
    engine := gin.Default()

    models := []interface{}{
      &User{},
      &Post{},
    }

    cfg := gg.Config{
      GormConfig: &gorm.Config{},
      Database: &gg.SQLiteDatabase{"user.db"},
      Models: models,
      OutputFormat: gg.IndentedJSON
    }

    engine.Use(gg.Middleware(cfg))

    db, _ := cfg.OpenDB()
    db.AutoMigrate(models...)

    engine.GET("/user", gg.SetModel(&User{}), gg.QuerySearch())
    engine.POST("/user", gg.SetModel(&User{}), gg.BodyCreate())
    engine.GET("/post", gg.SetModel(&Post{}), gg.QuerySearch())
    engine.POST("/post", gg.SetModel(&Post{}), gg.BodyCreate())

    engine.Run()
  }
```

# Generic handler functions

## QuerySearch, BodySearch

QuerySearch and BodySearch serve the same purpose: search tables.
QuerySearch uses the query string for search parameters.
BodySearch uses post data for search parameters.

```
  // curl "http://localhost/user?id_gte=5"
  engine.GET('/user', gg.SetModel(&User{}), gg.QuerySearch())

  // curl "http://localhost/user" -XPOST -d '{"id_gte" : 5}'
  engine.POST('/user', gg.SetModel(&User{}), gg.BodySearch())
```

### Search Parameters

Search parameters are made by adding a suffix to the db column name.
Available suffixs are :
* `_gte, _gt` - greater than or equal, greater than
* `_lte`,`_lt` - less than or equal, less than
* `_ne` - not equal
* `_contains` - string contains

Multiple search parameters are allowed on the same column name:

```
  curl "http://localhost/user?id_gte=5&id_lt=10"
```

## SearchByColumn

Queries the database for entries with a column that matches the url parameter.

```
  engine.GET('/user/:q', gg.SetModel(&User{}), gg.SearchByColumn("q", "group"))
```

Also supports search parameters in the column field:

```
  engine.GET('/user/:q', gg.SetModel(&User{}), gg.SearchByColumn("q", "id_gte"))
```

## GetByID

Queries the database for an entry that has a primary key that matches the given url parameter.

```
  engine.GET('/user/:id', gg.SetModel(&User{}), gg.GetByID("id"))
```

## BodyCreate

The BodyCreate handler creates a model of a specific model type using post data.
All fields are required, except for those that are autogenerated or that have default values.
Note: If a type mismatch occurs, the zero value for the field will be used.

```
  engine.POST('/user', gg.SetModel(&User{}), gg.BodyCreate())
```

## DeleteByID

Deletes the entry with aprimary key matching an url parameter

```
  engine.DELETE('/user/:id', gg.SetModel(&User{}), gg.Delete("id"))
```

## UpdateByID

Updates the entry with a primary key matching an url parameter.
Data is passed through request post data.

```
  engine.POST('/user/:id', gg.SetModel(&User{}), gg.UpdateByID("id"))
```

## MutateByID

Mutates a model using a mutator function.


```
  engine.GET('/user/:id/assign', gg.SetModel(&User{}), gg.MutateByID("id", func(m interface{}) interface{} { model := m.(User) })) 
```

## MutateColumn

Mutates a column using a mutator function
The mutator function must accept and return the type of the given column for the model.

```
  engine.GET('/user/:id/increment', gg.SetModel(&User{}), gg.MutateColumn("id", "column", func(count int) int { return count++ })) 
```

# Middleware

The middleware sets three keys in the context:

* "DB" - the gorm database connection
* "ModelSchemaMap" - the mapping between model types and gorm Schemas
* "DefaultOutput" - the default output function to use

# SetModel

The SetModel handler sets two keys in the context:

* "Model" - The type of model the handler deals with
* "Schema" - The gorm schema of the given model

# Example Custom Configuration

The following would create two endpoints that provide the count of Users and Posts in the database

```
  func main() {
    engine := gin.Default()
    cfg := gg.Config{
      ...
    }
    engine.Use(gg.Middleware(cfg))
    engine.GET("/user/count", gg.SetModel(&User{}), GetCount)
    engine.GET("/post/count", gg.SetModel(&Post{}), GetCount)
    engine.Run()
  }

  func GetCount(ctx *gin.Context) {
    db := ctx.Get("DB").(*gorm.DB)
    model := ctx.Get("Model")
    count := db.Model(model).Count()
    ctx.JSON(200, gin.H{ 'count' : count })
  }
```

The GetCount function could be rewritten with provided convenience functions:

```
  func GetCount(ctx *gin.Context) {
    db := gg.GetDB(ctx)
    model := gg.GetModel(ctx)
    count := db.Model(model).Count()
    gg.DefaultOutput(ctx, 200, gin.H{ 'count': count})
  }
```

The above also has the added benefit of allowing the switching of output types based on the Config.DefaultOutputFormat value.

